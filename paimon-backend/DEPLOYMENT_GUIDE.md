# Paimon Backend Deployment Guide

æœ¬æŒ‡å—æ¶µç›–å¦‚ä½•å°† Paimon Backend API éƒ¨ç½²åˆ° Railway æˆ– Render äº‘å¹³å°ã€‚

---

## ğŸ“‹ å‰ç½®æ¡ä»¶

1. **ç¯å¢ƒå‡†å¤‡**
   - PostgreSQL æ•°æ®åº“ï¼ˆæ¨è Supabaseï¼‰
   - Redis å®ä¾‹ï¼ˆæ¨è Upstashï¼‰
   - Python 3.11+
   - Dockerï¼ˆæœ¬åœ°æµ‹è¯•ï¼‰

2. **ç¯å¢ƒå˜é‡**
   - `DATABASE_URL`: PostgreSQL è¿æ¥å­—ç¬¦ä¸²
   - `REDIS_URL`: Redis è¿æ¥å­—ç¬¦ä¸²
   - `JWT_SECRET`: JWT å¯†é’¥ï¼ˆè‡³å°‘ 32 å­—ç¬¦ï¼‰
   - `ALLOWED_ORIGINS`: CORS å…è®¸çš„æºï¼ˆé€—å·åˆ†éš”ï¼‰
   - `ENVIRONMENT`: production/staging/development
   - `DEBUG`: true/false

---

## ğŸš€ Railway éƒ¨ç½²

### 1. å‡†å¤‡å·¥ä½œ

```bash
# å®‰è£… Railway CLI
npm install -g @railway/cli

# ç™»å½• Railway
railway login
```

### 2. åˆ›å»ºé¡¹ç›®

```bash
# åˆå§‹åŒ– Railway é¡¹ç›®
railway init

# é“¾æ¥åˆ°ç°æœ‰é¡¹ç›®ï¼ˆå¦‚æœå·²åˆ›å»ºï¼‰
railway link <project-id>
```

### 3. é…ç½®ç¯å¢ƒå˜é‡

åœ¨ Railway Dashboard ä¸­è®¾ç½®ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼š

```
DATABASE_URL=postgresql+asyncpg://user:pass@host:5432/dbname
REDIS_URL=redis://default:password@host:6379
JWT_SECRET=your-super-secret-key-at-least-32-characters
ALLOWED_ORIGINS=https://your-frontend-domain.com,https://www.your-frontend-domain.com
ENVIRONMENT=production
DEBUG=false
```

### 4. éƒ¨ç½²

```bash
# éƒ¨ç½²åˆ° Railway
railway up

# æŸ¥çœ‹éƒ¨ç½²æ—¥å¿—
railway logs

# æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€
railway status
```

### 5. è¿è¡Œæ•°æ®åº“è¿ç§»

```bash
# è¿æ¥åˆ° Railway shell
railway run bash

# è¿è¡Œ Alembic è¿ç§»
alembic upgrade head
```

### 6. éªŒè¯éƒ¨ç½²

```bash
# æ£€æŸ¥å¥åº·çŠ¶æ€
curl https://your-app.railway.app/health

# é¢„æœŸå“åº”ï¼š
{
  "status": "healthy",
  "service": "paimon-backend",
  "database": {"connected": true},
  "redis": {"connected": true},
  "timestamp": "2025-11-15T05:00:00Z"
}
```

---

## ğŸŒ Render éƒ¨ç½²

### 1. åˆ›å»ºé¡¹ç›®

1. è®¿é—® [Render Dashboard](https://dashboard.render.com/)
2. ç‚¹å‡» "New +" â†’ "Web Service"
3. è¿æ¥ GitHub ä»“åº“

### 2. é…ç½®æœåŠ¡

**Build Settings**:
- Environment: `Docker`
- Dockerfile Path: `./Dockerfile`
- Docker Build Context: `./paimon-backend`

**Health Check**:
- Health Check Path: `/health`

### 3. é…ç½®ç¯å¢ƒå˜é‡

åœ¨ Render Dashboard æ·»åŠ ç¯å¢ƒå˜é‡ï¼š

```
ENVIRONMENT=production
DEBUG=false
LOG_LEVEL=info
DATABASE_URL=<from-database>
REDIS_URL=<your-redis-url>
JWT_SECRET=<auto-generated>
ALLOWED_ORIGINS=https://your-frontend.com
```

### 4. åˆ›å»ºæ•°æ®åº“

1. åœ¨ Render Dashboard åˆ›å»º PostgreSQL æ•°æ®åº“
2. è¿æ¥æ•°æ®åº“åˆ° Web Serviceï¼ˆè‡ªåŠ¨è®¾ç½® DATABASE_URLï¼‰

### 5. éƒ¨ç½²

1. æäº¤ä»£ç åˆ° GitHub
2. Render è‡ªåŠ¨è§¦å‘éƒ¨ç½²
3. æŸ¥çœ‹ "Logs" ç›‘æ§éƒ¨ç½²è¿›åº¦

### 6. è¿è¡Œæ•°æ®åº“è¿ç§»

æ–¹æ³• 1ï¼šä½¿ç”¨ Render Shell
```bash
# åœ¨ Render Dashboard â†’ Shell
alembic upgrade head
```

æ–¹æ³• 2ï¼šæ·»åŠ éƒ¨ç½² Hook
åœ¨ `render.yaml` ä¸­æ·»åŠ ï¼š
```yaml
buildCommand: pip install poetry && poetry install --no-dev && alembic upgrade head
```

---

## ğŸ³ Docker æœ¬åœ°æµ‹è¯•

### 1. æ„å»ºé•œåƒ

```bash
cd paimon-backend

# æ„å»º Docker é•œåƒ
docker build -t paimon-backend:latest .
```

### 2. è¿è¡Œå®¹å™¨

```bash
# ä½¿ç”¨ç¯å¢ƒå˜é‡æ–‡ä»¶
docker run -p 8000:8000 \
  --env-file .env \
  paimon-backend:latest

# æˆ–ç›´æ¥ä¼ é€’ç¯å¢ƒå˜é‡
docker run -p 8000:8000 \
  -e DATABASE_URL=sqlite+aiosqlite:///./test.db \
  -e REDIS_URL=redis://localhost:6379 \
  -e JWT_SECRET=test-secret-key-for-local-development \
  -e ENVIRONMENT=development \
  -e DEBUG=true \
  paimon-backend:latest
```

### 3. éªŒè¯

```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:8000/health

# API æ–‡æ¡£
open http://localhost:8000/docs
```

---

## ğŸ”§ æ•°æ®åº“è¿ç§»

### åˆ›å»ºæ–°è¿ç§»

```bash
# è‡ªåŠ¨ç”Ÿæˆè¿ç§»æ–‡ä»¶
alembic revision --autogenerate -m "Add new table"

# æ‰‹åŠ¨åˆ›å»ºè¿ç§»æ–‡ä»¶
alembic revision -m "Custom migration"
```

### åº”ç”¨è¿ç§»

```bash
# å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬
alembic upgrade head

# å‡çº§åˆ°ç‰¹å®šç‰ˆæœ¬
alembic upgrade <revision-id>

# é™çº§ä¸€ä¸ªç‰ˆæœ¬
alembic downgrade -1

# æŸ¥çœ‹å½“å‰ç‰ˆæœ¬
alembic current

# æŸ¥çœ‹è¿ç§»å†å²
alembic history
```

---

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### Railway

```bash
# å®æ—¶æ—¥å¿—
railway logs -f

# æŸ¥çœ‹æœ€è¿‘ 100 æ¡æ—¥å¿—
railway logs -n 100
```

### Render

1. Dashboard â†’ Logs
2. æ”¯æŒå®æ—¶æ—¥å¿—æµ
3. å¯ä¸‹è½½å†å²æ—¥å¿—

### å¥åº·æ£€æŸ¥ç«¯ç‚¹

```bash
# å®Œæ•´å¥åº·çŠ¶æ€
curl https://your-app.com/health

# å“åº”ç¤ºä¾‹
{
  "status": "healthy",  # æˆ– "degraded"
  "service": "paimon-backend",
  "database": {
    "connected": true,
    "error": null  # ä»…åœ¨å¤±è´¥æ—¶æ˜¾ç¤º
  },
  "redis": {
    "connected": true,
    "error": null
  },
  "timestamp": "2025-11-15T05:00:00+00:00"
}
```

---

## ğŸ” å®‰å…¨æœ€ä½³å®è·µ

1. **ç¯å¢ƒå˜é‡**
   - âœ… ä½¿ç”¨å¹³å°æä¾›çš„å¯†é’¥ç®¡ç†
   - âœ… å®šæœŸè½®æ¢ JWT_SECRET
   - âŒ ä¸è¦åœ¨ä»£ç ä¸­ç¡¬ç¼–ç å¯†é’¥

2. **æ•°æ®åº“**
   - âœ… ä½¿ç”¨ SSL è¿æ¥
   - âœ… å¯ç”¨è¿æ¥æ± é™åˆ¶
   - âœ… å®šæœŸå¤‡ä»½

3. **CORS**
   - âœ… ä»…å…è®¸ç‰¹å®šåŸŸå
   - âŒ é¿å…ä½¿ç”¨é€šé…ç¬¦ `*`

4. **æ—¥å¿—**
   - âœ… ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ `LOG_LEVEL=info`
   - âŒ ä¸è¦è®°å½•æ•æ„Ÿä¿¡æ¯ï¼ˆå¯†ç ã€Tokenï¼‰

---

## ğŸš¨ æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: æ•°æ®åº“è¿æ¥å¤±è´¥

**ç—‡çŠ¶**: `health` ç«¯ç‚¹æŠ¥å‘Š `database.connected: false`

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥ `DATABASE_URL` æ ¼å¼ï¼š
   ```
   postgresql+asyncpg://user:pass@host:5432/dbname
   ```
2. ç¡®è®¤æ•°æ®åº“è¿è¡Œä¸”å¯è®¿é—®
3. æ£€æŸ¥é˜²ç«å¢™è§„åˆ™
4. éªŒè¯ç”¨æˆ·åå’Œå¯†ç 

### é—®é¢˜ 2: Redis è¿æ¥å¤±è´¥

**ç—‡çŠ¶**: `health` ç«¯ç‚¹æŠ¥å‘Š `redis.connected: false`

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥ `REDIS_URL` æ ¼å¼ï¼š
   ```
   redis://default:password@host:6379
   ```
2. ç¡®è®¤ Redis è¿è¡Œ
3. æ£€æŸ¥ Redis å¯†ç å’Œç«¯å£

### é—®é¢˜ 3: è¿ç§»å¤±è´¥

**ç—‡çŠ¶**: `alembic upgrade head` æŠ¥é”™

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥å½“å‰ç‰ˆæœ¬
alembic current

# æŸ¥çœ‹è¿ç§»å†å²
alembic history

# æ‰‹åŠ¨æ ‡è®°ç‰ˆæœ¬ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
alembic stamp <revision-id>

# é‡æ–°åº”ç”¨è¿ç§»
alembic upgrade head
```

### é—®é¢˜ 4: ç«¯å£å ç”¨

**ç—‡çŠ¶**: Docker å¯åŠ¨å¤±è´¥ "port already in use"

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æŸ¥æ‰¾å ç”¨ç«¯å£çš„è¿›ç¨‹
lsof -i :8000

# æ€æ­»è¿›ç¨‹
kill -9 <PID>

# æˆ–ä½¿ç”¨ä¸åŒç«¯å£
docker run -p 9000:8000 paimon-backend:latest
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Railway æ–‡æ¡£](https://docs.railway.app/)
- [Render æ–‡æ¡£](https://render.com/docs)
- [FastAPI éƒ¨ç½²](https://fastapi.tiangolo.com/deployment/)
- [Alembic æ–‡æ¡£](https://alembic.sqlalchemy.org/)
- [Docker æœ€ä½³å®è·µ](https://docs.docker.com/develop/dev-best-practices/)

---

## âœ… éƒ¨ç½²æ£€æŸ¥æ¸…å•

**éƒ¨ç½²å‰**:
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ˆ`poetry run pytest`ï¼‰
- [ ] ç¯å¢ƒå˜é‡å·²é…ç½®
- [ ] æ•°æ®åº“å·²åˆ›å»º
- [ ] Redis å®ä¾‹å·²å‡†å¤‡
- [ ] `alembic.ini` é…ç½®æ­£ç¡®

**éƒ¨ç½²å**:
- [ ] å¥åº·æ£€æŸ¥è¿”å› 200 (`/health`)
- [ ] API æ–‡æ¡£å¯è®¿é—® (`/docs`)
- [ ] æ•°æ®åº“è¿æ¥æˆåŠŸ
- [ ] Redis è¿æ¥æˆåŠŸ
- [ ] æ—¥å¿—æ— é”™è¯¯
- [ ] CORS é…ç½®æ­£ç¡®ï¼ˆå‰ç«¯å¯è®¿é—®ï¼‰

**ç”Ÿäº§ç¯å¢ƒ**:
- [ ] `DEBUG=false`
- [ ] `ENVIRONMENT=production`
- [ ] `LOG_LEVEL=info`
- [ ] HTTPS å·²å¯ç”¨
- [ ] æ•°æ®åº“å¤‡ä»½ç­–ç•¥å·²è®¾ç½®
- [ ] ç›‘æ§å‘Šè­¦å·²é…ç½®

---

**æœ€åæ›´æ–°**: 2025-11-15
**ç‰ˆæœ¬**: 1.0.0
**ç»´æŠ¤è€…**: Paimon DEX Team
