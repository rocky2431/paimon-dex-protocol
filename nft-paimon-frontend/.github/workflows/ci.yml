name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # Contract Address Verification Job
  verify-addresses:
    name: Verify Contract Addresses
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Sync contract addresses
        run: npm run sync-addresses

      - name: Verify contract addresses
        run: npm run verify-addresses

      - name: Check for configuration drift
        run: |
          git diff --exit-code src/config/chains/generated/testnet.ts || (
            echo ""
            echo "❌ Contract addresses are out of sync!"
            echo ""
            echo "The generated configuration file differs from the committed version."
            echo "This indicates that contract addresses have changed but were not synced."
            echo ""
            echo "To fix this issue:"
            echo "  1. Run: npm run sync-addresses"
            echo "  2. Review the changes in src/config/chains/generated/testnet.ts"
            echo "  3. Commit the updated configuration file"
            echo "  4. Push your changes"
            echo ""
            exit 1
          )

      - name: Report verification success
        if: success()
        run: |
          echo ""
          echo "✅ Contract address verification passed!"
          echo ""
          echo "All contract addresses are synchronized and valid."
          echo ""

  # Type Check Job
  type-check:
    name: TypeScript Type Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run type check
        run: npm run type-check

  # Unit Tests Job
  test:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm run test:ci

      - name: Upload coverage reports
        if: always()
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/coverage-final.json
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  # Build Job
  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: [verify-addresses, type-check, test]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Check build output
        run: |
          if [ ! -d ".next" ]; then
            echo "❌ Build failed: .next directory not found"
            exit 1
          fi
          echo "✅ Build successful"

  # E2E Tests Job (optional, runs only on main branch)
  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: [build]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run E2E tests
        run: npm run test:e2e:chromium

      - name: Upload E2E test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: playwright-report/
          retention-days: 7

  # Lint Job (optional)
  lint:
    name: Lint Code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

  # Summary Job
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [verify-addresses, type-check, test, build, lint]
    if: always()

    steps:
      - name: Check all jobs status
        run: |
          echo "CI Pipeline Summary:"
          echo "===================="
          echo ""
          echo "verify-addresses: ${{ needs.verify-addresses.result }}"
          echo "type-check: ${{ needs.type-check.result }}"
          echo "test: ${{ needs.test.result }}"
          echo "build: ${{ needs.build.result }}"
          echo "lint: ${{ needs.lint.result }}"
          echo ""

          if [ "${{ needs.verify-addresses.result }}" != "success" ] || \
             [ "${{ needs.type-check.result }}" != "success" ] || \
             [ "${{ needs.test.result }}" != "success" ] || \
             [ "${{ needs.build.result }}" != "success" ] || \
             [ "${{ needs.lint.result }}" != "success" ]; then
            echo "❌ CI Pipeline Failed"
            exit 1
          else
            echo "✅ CI Pipeline Passed"
          fi
